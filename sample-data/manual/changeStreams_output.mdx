---
selectors:
  drivers:
    c:
      - type: text
        position:
          start:
            line:
              $numberInt: 189
        value: C
    csharp:
      - type: text
        position:
          start:
            line:
              $numberInt: 189
        value: "C#"
    go:
      - type: text
        position:
          start:
            line:
              $numberInt: 189
        value: Go
    java-sync:
      - type: text
        position:
          start:
            line:
              $numberInt: 189
        value: "Java (Sync)"
    kotlin-coroutine:
      - type: text
        position:
          start:
            line:
              $numberInt: 189
        value: "Kotlin (Coroutine)"
    motor:
      - type: text
        position:
          start:
            line:
              $numberInt: 189
        value: Motor
    nodejs:
      - type: text
        position:
          start:
            line:
              $numberInt: 189
        value: Node.js
    php:
      - type: text
        position:
          start:
            line:
              $numberInt: 189
        value: PHP
    python:
      - type: text
        position:
          start:
            line:
              $numberInt: 189
        value: Python
    ruby:
      - type: text
        position:
          start:
            line:
              $numberInt: 189
        value: Ruby
    swift-async:
      - type: text
        position:
          start:
            line:
              $numberInt: 189
        value: "Swift (Async)"
    swift-sync:
      - type: text
        position:
          start:
            line:
              $numberInt: 189
        value: "Swift (Sync)"
headings:
  - depth:
      $numberInt: 2
    id: availability
    title:
      - type: text
        position:
          start:
            line:
              $numberInt: 40
        value: Availability
    selector_ids: {}
  - depth:
      $numberInt: 2
    id: connect
    title:
      - type: text
        position:
          start:
            line:
              $numberInt: 67
        value: Connect
    selector_ids: {}
  - depth:
      $numberInt: 2
    id: watch-a-collection--database--or-deployment
    title:
      - type: text
        position:
          start:
            line:
              $numberInt: 84
        value: "Watch a Collection, Database, or Deployment"
    selector_ids: {}
  - depth:
      $numberInt: 2
    id: change-stream-performance-considerations
    title:
      - type: text
        position:
          start:
            line:
              $numberInt: 135
        value: "Change Stream Performance Considerations"
    selector_ids: {}
  - depth:
      $numberInt: 2
    id: open-a-change-stream
    title:
      - type: text
        position:
          start:
            line:
              $numberInt: 164
        value: "Open A Change Stream"
    selector_ids: {}
  - depth:
      $numberInt: 2
    id: modify-change-stream-output
    title:
      - type: text
        position:
          start:
            line:
              $numberInt: 383
        value: "Modify Change Stream Output"
    selector_ids: {}
  - depth:
      $numberInt: 2
    id: lookup-full-document-for-update-operations
    title:
      - type: text
        position:
          start:
            line:
              $numberInt: 583
        value: "Lookup Full Document for Update Operations"
    selector_ids: {}
  - depth:
      $numberInt: 2
    id: resume-a-change-stream
    title:
      - type: text
        position:
          start:
            line:
              $numberInt: 830
        value: "Resume a Change Stream"
    selector_ids: {}
  - depth:
      $numberInt: 2
    id: use-cases
    title:
      - type: text
        position:
          start:
            line:
              $numberInt: 1200
        value: "Use Cases"
    selector_ids: {}
  - depth:
      $numberInt: 2
    id: access-control
    title:
      - type: text
        position:
          start:
            line:
              $numberInt: 1211
        value: "Access Control"
    selector_ids: {}
  - depth:
      $numberInt: 2
    id: event-notification
    title:
      - type: text
        position:
          start:
            line:
              $numberInt: 1245
        value: "Event Notification"
    selector_ids: {}
  - depth:
      $numberInt: 2
    id: collation
    title:
      - type: text
        position:
          start:
            line:
              $numberInt: 1262
        value: Collation
    selector_ids: {}
  - depth:
      $numberInt: 2
    id: change-streams-and-orphan-documents
    title:
      - type: text
        position:
          start:
            line:
              $numberInt: 1268
        value: "Change Streams and Orphan Documents"
    selector_ids: {}
  - depth:
      $numberInt: 2
    id: change-streams-with-document-pre--and-post-images
    title:
      - type: text
        position:
          start:
            line:
              $numberInt: 1275
        value: "Change Streams with Document Pre- and Post-Images"
    selector_ids: {}
---

import ChangeStreamsOptimization from './includes/change-streams-optimization.mdx';
import ChangestreamRcMajority4_2 from './includes/extracts/changestream-rc-majority-4.2.mdx';
import ChangeStreamSupport from './includes/stable-api/change-stream-support.mdx';
import ChangestreamRemoveShard from './includes/extracts/changestream-remove-shard.mdx';
import ChangestreamCursorOpen from './includes/extracts/changestream-cursor-open.mdx';
import ChangestreamAvailablePipelineStages from './includes/extracts/changestream-available-pipeline-stages.mdx';
import FactChangeStreamsModifyOutput from './includes/fact-change-streams-modify-output.mdx';
import _4_2ChangesChangeStreamModificationError from './includes/extracts/4.2-changes-change-stream-modification-error.mdx';
import ChangestreamInvalidEvents from './includes/extracts/changestream-invalid-events.mdx';
import NoteDecodeResumeTokens from './includes/note-decode-resume-tokens.mdx';
import ChangeStreamsAndOrphans from './includes/change-streams-and-orphans.mdx';
import ChangeStreamPreAndPostImagesIntroduction from './includes/change-stream-pre-and-post-images-introduction.mdx';
import DowngradeForPreAndPostImages from './includes/downgrade-for-pre-and-post-images.mdx';
import ChangeStreamPreAndPostImagesAdditionalInformation from './includes/change-stream-pre-and-post-images-additional-information.mdx';

<span id="std-label-changeStreams" />

<span id="std-label-collection_watch" />

# Change Streams

<DefaultDomain>
  mongodb
</DefaultDomain>

<Facet name="genre" values="reference" />

<Contents local={true} backlinks="none" depth={{"$numberInt":"1"}} class="twocols">
  On this page
</Contents>

Change streams allow applications to access real-time data changes
without the prior complexity and risk of manually tailing the <Ref url="oplog">oplog</Ref>.
Applications can use change streams to subscribe to all data changes on
a single collection, a database, or an entire deployment, and
immediately react to them. Because change streams use the aggregation
framework, applications can also filter for specific changes or
transform the notifications at will.

<ChangeStreamsOptimization />

## Availability

Change streams are available for <Ref url="replication">replica sets</Ref> and
<Ref url="sharding-background">sharded clusters</Ref>:

* **Storage Engine.**

  The replica sets and sharded clusters must use the <Ref url="storage-wiredtiger">WiredTiger</Ref> storage engine. Change streams can also be used
  on deployments that employ MongoDB's
  <Ref url="encrypted-storage-engine">encryption-at-rest</Ref> feature.

* **Replica Set Protocol Version.**

  The replica sets and sharded clusters must use replica set protocol
  version 1 (<Ref url="rsconf.protocolVersion">`pv1`</Ref>).

* **Read Concern "majority" Enablement.**

  <ChangestreamRcMajority4_2 />

### Stable API Support

<ChangeStreamSupport />

## Connect

Connections for a change stream can either use DNS seed lists
with the `+srv` connection option or by listing the servers individually
in the connection string.

If the driver loses the connection to a change stream or the connection goes
down, it attempts to reestablish a connection to the change stream through
another node in the cluster that has a matching
<Ref url="connections-read-preference">read preference</Ref>. If the driver cannot find
a node with the correct read preference, it throws an exception.

For more information, see <Ref url="mongodb-uri">Connection String URI Format</Ref>.

<span id="std-label-changeStreams-watch-deployment" />

## Watch a Collection, Database, or Deployment

You can open change streams against:

<ListTable header-rows={{"$numberInt":"1"}} widths="15 85">
  * * Target

    * Description

  * * A collection

    * You can open a change stream cursor for a single collection
      (except `system` collections, or any collections in the
      `admin`, `local`, and `config` databases).

      The examples on this page use the MongoDB drivers to open and
      work with a change stream cursor for a single collection. See
      also the <Ref url="https://www.mongodb.com/docs/mongodb-shell/#mongodb-binary-bin.mongosh">`mongosh`</Ref> method
      <Ref url="db.collection.watch">`db.collection.watch()`</Ref>.

  * * A database

    * You can open a change stream cursor for a single database (excluding
      `admin`, `local`, and `config` database) to watch for changes to
      all its non-system collections.

      For the MongoDB driver method, refer to your driver
      documentation. See also the <Ref url="https://www.mongodb.com/docs/mongodb-shell/#mongodb-binary-bin.mongosh">`mongosh`</Ref> method
      <Ref url="db.watch">`db.watch()`</Ref>.

  * * A deployment

    * You can open a change stream cursor for a deployment (either a replica
      set or a sharded cluster) to watch for changes to all non-system
      collections across all databases except for `admin`, `local`, and
      `config`.

      For the MongoDB driver method, refer to your driver
      documentation. See also the <Ref url="https://www.mongodb.com/docs/mongodb-shell/#mongodb-binary-bin.mongosh">`mongosh`</Ref> method
      <Ref url="Mongo.watch">`Mongo.watch()`</Ref>.
</ListTable>

<Note>
  Change Stream Examples

  The examples on this page use the MongoDB drivers to illustrate how
  to open a change stream cursor for a collection and work with the
  change stream cursor.
</Note>

## Change Stream Performance Considerations

If the amount of active change streams opened against a database exceeds the
<Ref url="connection-pool-overview">connection pool size</Ref>, you may
experience notification latency. Each change stream uses a connection
and a <Ref url="manual-reference-commands-getMore">getMore</Ref>
operation on the change stream for the period of time that it waits for the next event.
To avoid any latency issues, you should ensure that the pool size is greater than the
number of opened change streams. For details see the <Ref url="maxpoolsize-cp-setting">maxPoolSize</Ref> setting.

### Sharded Cluster Considerations

When a change stream is opened on a sharded cluster:

* The <Ref url="bin.mongos">`mongos`</Ref> creates individual change streams on **each
  shard**. This behavior occurs regardless of whether the change stream
  targets a particular shard key range.

* When the `mongos` receives change stream results, it sorts and
  filters those results. If needed, the `mongos` also performs a
  `fullDocument` lookup.

For best performance, limit the use of <Ref url="pipe.$lookup">`$lookup`</Ref> queries in
change streams.

<span id="std-label-open-change-stream" />

## Open A Change Stream

To open a change stream:

* For a replica set, you can issue the open change stream operation
  from any of the data-bearing members.

* For a sharded cluster, you must issue the open change stream
  operation from the <Ref url="bin.mongos">`mongos`</Ref>.

The following example opens a change stream for a collection and
iterates over the cursor to retrieve the change stream documents.
[^start-time]

***

<SubstitutionReference name="arrow">➤</SubstitutionReference> Use the **Select your language** drop-down menu in the
upper-right to set the language of the examples on this page.

***

<TabsSelector>
  drivers
</TabsSelector>

<Tabs tabset="drivers">
  <Tab tabid="c">
    C

    The C examples below assume that you have [connected to a MongoDB replica set and have accessed a database](https://www.mongodb.com/docs/languages/c/c-driver/current/databases-collections/#access-a-database)
    that contains an `inventory` collection.

    ```c
    // Source: /driver-examples/test-mongoc-sample-commands.c
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="csharp">
    C#

    The C# examples below assume that you have [connected to a MongoDB replica set and have accessed a database](http://mongodb.github.io/mongo-csharp-driver/2.4/getting_started/quick_tour/#make-a-connection/)
    that contains an `inventory` collection.

    ```csharp
    // Source: /driver-examples/ChangeStreamExamples.cs
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="go">
    Go

    The Go examples below assume that you have [connected to a MongoDB replica set and have accessed a database](https://godoc.org/go.mongodb.org/mongo-driver/mongo#NewClient/)
    that contains an `inventory` collection.

    ```go
    // Source: /driver-examples/go_examples.go
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="java-sync">
    Java (Sync)

    The Java examples below assume that you have [connected to a MongoDB replica set and have accessed a database](http://mongodb.github.io/mongo-java-driver/3.6/driver/tutorials/databases-collections/)
    that contains an `inventory` collection.

    ```java
    // Source: /driver-examples/DocumentationSamples.java
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="kotlin-coroutine">
    Kotlin (Coroutine)

    The Kotlin examples below assume that you are connected to a MongoDB replica set and can access a database
    that contains the `inventory` collection. To learn more about completing these tasks, see the
    [Kotlin Coroutine Driver Databases and Collections](https://www.mongodb.com/docs/drivers/kotlin/coroutine/current/fundamentals/databases-collections/) guide.

    ```kotlin
    // Source: /driver-examples/kotlin_examples.kt
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="motor">
    Motor

    The examples below assume that you have [connected to a MongoDB replica set and have accessed a database](https://motor.readthedocs.io/en/stable/tutorial-asyncio.html#creating-a-client)
    that contains an `inventory` collection.

    ```python
    // Source: /driver-examples/test_examples_motor.py
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="nodejs">
    Node.js

    The Node.js examples below assume that you have [connected to a MongoDB replica set and have accessed a database](https://mongodb.github.io/node-mongodb-native/api-generated/mongoclient.html#connect)
    that contains an `inventory` collection.

    The following example uses stream to process the change events.

    ```javascript
    // Source: /driver-examples/node_changestreams.js
    // TODO: Content from external file not available during conversion
    ```

    Alternatively, you can also use iterator to process the change events:

    ```javascript
    // Source: /driver-examples/node_changestreams.js
    // TODO: Content from external file not available during conversion
    ```

    ChangeStream extends [EventEmitter](https://mongodb.github.io/node-mongodb-native/5.7/classes/TypedEventEmitter.html).
  </Tab>

  <Tab tabid="php">
    PHP

    The examples below assume that you have [connected to a MongoDB replica  set and have accessed a database](https://www.mongodb.com/docs/php-library/current/reference/method/MongoDBClient__construct/)
    that contains an `inventory` collection.

    ```php
    // Source: /driver-examples/DocumentationExamplesTest.php
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="python">
    Python

    The Python examples below assume that you have [connected to a MongoDB replica set and have accessed a database](https://www.mongodb.com/docs/drivers/pymongo/) that contains an `inventory` collection.

    ```python
    // Source: /driver-examples/test_examples.py
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="ruby">
    Ruby

    The examples below assume that you have [connected to a MongoDB replica set and have accessed a database](https://www.mongodb.com/docs/ruby-driver/current/reference/create-client/)
    that contains an `inventory` collection.

    ```ruby
    // Source: /driver-examples/change_stream_examples_spec.rb
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="swift-async">
    Swift (Async)

    The Swift (Async) examples below assume that you have
    [connected to a MongoDB replica set and have accessed a
    database](https://mongodb.github.io/mongo-swift-driver/docs/current/MongoSwift/Classes/MongoClient.html)
    that contains an `inventory` collection.

    ```swift
    // Source: /driver-examples/swiftAsync.swift
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="swift-sync">
    Swift (Sync)

    The Swift (Sync) examples below assume that you have
    [connected to a MongoDB replica set and have accessed a
    database](https://mongodb.github.io/mongo-swift-driver/docs/current/MongoSwiftSync/Classes/MongoClient.html)
    that contains an `inventory` collection.

    ```swift
    // Source: /driver-examples/swiftSync.swift
    // TODO: Content from external file not available during conversion
    ```
  </Tab>
</Tabs>

To retrieve the <Ref url="change-stream-output">data change event</Ref> from
the cursor, iterate the change stream cursor. For information on the
change stream event, see <Ref url="change-stream-output">Change Events</Ref>.

<ChangestreamCursorOpen />

<Note>
  The lifecycle of an unclosed cursor is language-dependent.
</Note>

[^start-time]: You can specify a `startAtOperationTime` to open the cursor at a particular
    point in time. If the specified starting point is in the past, it must be in
    the time range of the oplog.

<span id="std-label-change-stream-modify-output" />

## Modify Change Stream Output

***

<SubstitutionReference name="arrow">➤</SubstitutionReference> Use the **Select your language** drop-down menu in the
upper-right to set the language of the examples on this page.

***

<Tabs tabset="drivers">
  <Tab tabid="c">
    C

    <FactChangeStreamsModifyOutput />

    ```c
    // Source: /driver-examples/test-mongoc-sample-commands.c
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="csharp">
    C#

    <FactChangeStreamsModifyOutput />

    ```csharp
    // Source: /driver-examples/ChangeStreamExamples.cs
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="go">
    Go

    <FactChangeStreamsModifyOutput />

    ```go
    // Source: /driver-examples/go_examples.go
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="java-sync">
    Java (Sync)

    <FactChangeStreamsModifyOutput />

    ```java
    MongoClient mongoClient = MongoClients.create("mongodb://<username>:<password>@<host>:<port>");

    // Select the MongoDB database and collection to open the change stream against

    MongoDatabase db = mongoClient.getDatabase("myTargetDatabase");

    MongoCollection<Document> collection = db.getCollection("myTargetCollection");

    // Create $match pipeline stage.
    List<Bson> pipeline = singletonList(Aggregates.match(Filters.or(
       Document.parse("{'fullDocument.username': 'alice'}"),
       Filters.in("operationType", asList("delete")))));

    // Create the change stream cursor, passing the pipeline to the
    // collection.watch() method

    MongoCursor<Document> cursor = collection.watch(pipeline).iterator();
    ```

    The `pipeline` list includes a single <Ref url="pipe.$match">`$match`</Ref> stage that
    filters for any operations that meet one or both of the following criteria:

    * `username` value is `alice`

    * `operationType` value is `delete`

    Passing the `pipeline` to the <Ref url="db.collection.watch">`watch()`</Ref> method directs the
    change stream to return notifications after passing them through the
    specified `pipeline`.
  </Tab>

  <Tab tabid="kotlin-coroutine">
    Kotlin (Coroutine)

    <FactChangeStreamsModifyOutput />

    ```kotlin
    // Source: /driver-examples/kotlin_examples.kt
    // TODO: Content from external file not available during conversion
    ```

    The `pipeline` list includes a single <Ref url="pipe.$match">`$match`</Ref> stage that
    filters for any operations that meet one or both of the following criteria:

    * `username` value is `alice`

    * `operationType` value is `delete`

    Passing the `pipeline` to the <Ref url="db.collection.watch">`watch()`</Ref> method directs the
    change stream to return notifications after passing them through the
    specified `pipeline`.
  </Tab>

  <Tab tabid="motor">
    Motor

    <FactChangeStreamsModifyOutput />

    ```python
    // Source: /driver-examples/test_examples_motor.py
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="nodejs">
    Node.js

    <FactChangeStreamsModifyOutput />

    The following example uses stream to process the change events.

    ```javascript
    // Source: /driver-examples/node_changestreams.js
    // TODO: Content from external file not available during conversion
    ```

    Alternatively, you can also use iterator to process the change events:

    ```javascript
    // Source: /driver-examples/node_changestreams.js
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="php">
    PHP

    <FactChangeStreamsModifyOutput />

    ```php
    // Source: /driver-examples/DocumentationExamplesTest.php
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="python">
    Python

    <FactChangeStreamsModifyOutput />

    ```python
    // Source: /driver-examples/test_examples.py
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="ruby">
    Ruby

    <FactChangeStreamsModifyOutput />
  </Tab>

  <Tab tabid="swift-async">
    Swift (Async)

    <FactChangeStreamsModifyOutput />

    ```swift
    // Source: /driver-examples/swiftAsync.swift
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="swift-sync">
    Swift (Sync)

    <FactChangeStreamsModifyOutput />

    ```swift
    // Source: /driver-examples/swiftSync.swift
    // TODO: Content from external file not available during conversion
    ```
  </Tab>
</Tabs>

<Tip>
  The <Ref url="change-stream-event-id">\_id</Ref> field of the change stream
  event document act as the <Ref url="change-stream-resume">resume token</Ref>. Do not use the pipeline to modify or remove
  the change stream event's `_id` field.

  <_4_2ChangesChangeStreamModificationError />

  See <Ref url="change-stream-output">Change Events</Ref> for more information on the change stream
  response document format.
</Tip>

<span id="std-label-change-streams-updateLookup" />

## Lookup Full Document for Update Operations

By default, change streams only return the delta of fields during
the update operation. However, you can configure the change stream
to return the most current majority-committed version of the updated
document.

***

<SubstitutionReference name="arrow">➤</SubstitutionReference> Use the **Select your language** drop-down menu in the
upper-right to set the language of the examples on this page.

***

<Tabs tabset="drivers">
  <Tab tabid="c">
    C

    To return the most current majority-committed version of the updated
    document, pass the `"fullDocument"` option with the `"updateLookup"` value to the
    `mongoc_collection_watch` method.

    In the example below, all update operations notifications
    include a `fullDocument` field that represents the *current*
    version of the document affected by the update operation.

    ```c
    // Source: /driver-examples/test-mongoc-sample-commands.c
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="csharp">
    C#

    To return the most current majority-committed version of the updated
    document, pass `"FullDocument = ChangeStreamFullDocumentOption.UpdateLookup"` to the
    <Ref url="db.collection.watch">`db.collection.watch()`</Ref> method.

    In the example below, all update operations notifications
    include a `FullDocument` field that represents the *current*
    version of the document affected by the update operation.

    ```csharp
    // Source: /driver-examples/ChangeStreamExamples.cs
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="go">
    Go

    To return the most current majority-committed version of the
    updated document, `SetFullDocument(options.UpdateLookup)`
    change stream option.

    ```go
    // Source: /driver-examples/go_examples.go
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="java-sync">
    Java (Sync)

    To return the most current majority-committed version of the updated
    document, pass `FullDocument.UPDATE_LOOKUP`  to the
    `db.collection.watch.fullDocument()` method.

    In the example below, all update operations notifications
    include a `FullDocument` field that represents the *current*
    version of the document affected by the update operation.

    ```java
    // Source: /driver-examples/DocumentationSamples.java
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="kotlin-coroutine">
    Kotlin (Coroutine)

    To return the most current majority-committed version of the updated
    document, pass `FullDocument.UPDATE_LOOKUP`  to the
    [ChangeStreamFlow.fullDocument()](https://mongodb.github.io/mongo-java-driver/4.11/apidocs/mongodb-driver-kotlin-coroutine/mongodb-driver-kotlin-coroutine/com.mongodb.kotlin.client.coroutine/-change-stream-flow/full-document.html) method.

    In the example below, all update operations notifications
    include a `FullDocument` field that represents the *current*
    version of the document affected by the update operation.

    ```kotlin
    // Source: /driver-examples/kotlin_examples.kt
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="motor">
    Motor

    To return the most current majority-committed version of the updated
    document, pass `full_document='updateLookup'` to the
    <Ref url="db.collection.watch">`db.collection.watch()`</Ref> method.

    In the example below, all update operations notifications
    include a `` `full_document `` field that represents the *current*
    version of the document affected by the update operation.

    ```python
    // Source: /driver-examples/test_examples_motor.py
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="nodejs">
    Node.js

    To return the most current majority-committed version of the updated
    document, pass `{ fullDocument: 'updateLookup' }` to the
    <Ref url="db.collection.watch">`db.collection.watch()`</Ref> method.

    In the example below, all update operations notifications
    include a `fullDocument` field that represents the *current*
    version of the document affected by the update operation.

    The following example uses stream to process the change events.

    ```javascript
    // Source: /driver-examples/node_changestreams.js
    // TODO: Content from external file not available during conversion
    ```

    Alternatively, you can also use iterator to process the change events:

    ```javascript
    // Source: /driver-examples/node_changestreams.js
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="php">
    PHP

    To return the most current
    majority-committed version of the updated document, pass
    `"fullDocument' => \MongoDB\Operation\ChangeStreamCommand::FULL_DOCUMENT_UPDATE_LOOKUP"`
    to the <Ref url="db.watch">`db.watch()`</Ref> method.

    In the example below, all update operations notifications
    include a `fullDocument` field that represents the *current*
    version of the document affected by the update operation.

    ```php
    // Source: /driver-examples/DocumentationExamplesTest.php
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="python">
    Python

    To return the most current majority-committed version of the updated
    document, pass `full_document='updateLookup'` to the
    <Ref url="db.collection.watch">`db.collection.watch()`</Ref> method.

    In the example below, all update operations notifications
    include a `full_document` field that represents the *current*
    version of the document affected by the update operation.

    ```python
    // Source: /driver-examples/test_examples.py
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="ruby">
    Ruby

    To return the most current majority-committed version of the updated
    document, pass `full_document: 'updateLookup'` to the
    <Ref url="db.watch">`db.watch()`</Ref> method.

    In the example below, all update operations notifications
    include a `full_document` field that represents the *current*
    version of the document affected by the update operation.

    ```ruby
    // Source: /driver-examples/change_stream_examples_spec.rb
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="swift-async">
    Swift (Async)

    To return the most current majority-committed version of
    the updated document, pass `options:
    ChangeStreamOptions(fullDocument: .updateLookup)` to the
    `watch()` method.

    ```swift
    // Source: /driver-examples/swiftAsync.swift
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="swift-sync">
    Swift (Sync)

    To return the most current majority-committed version of
    the updated document, pass `options:
    ChangeStreamOptions(fullDocument: .updateLookup)` to the
    `watch()` method.

    ```swift
    // Source: /driver-examples/swiftSync.swift
    // TODO: Content from external file not available during conversion
    ```
  </Tab>
</Tabs>

<Note>
  If there are one or more majority-committed operations that modified
  the updated document *after* the update operation but *before* the
  lookup, the full document returned may differ significantly from the
  document at the time of the update operation.

  However, the deltas included in the change stream document always
  correctly describe the watched collection changes that applied to
  that change stream event.

  The `fullDocument` field for an update event may be missing if one
  of the following is true:

  * If the document is deleted or if the collection is dropped in
    between the update and the lookup.

  * If the update changes the values for at least one of the fields in
    that collection's shard key.

  See <Ref url="change-stream-output">Change Events</Ref> for more information on the change
  stream response document format.
</Note>

<span id="std-label-change-stream-resume" />

## Resume a Change Stream

Change streams are resumable by specifying a resume token to either
<Ref url="change-stream-resume-after">resumeAfter</Ref> or
<Ref url="change-stream-start-after">startAfter</Ref> when opening the cursor.

<span id="std-label-change-stream-resume-after" />

### `resumeAfter` for Change Streams

You can resume a change stream after a specific event by passing a resume token
to `resumeAfter` when opening the cursor.

See <Ref url="change-stream-resume-token">Resume Tokens</Ref> for more information on the resume token.

<Important>
  * The oplog must have enough history to locate the operation
    associated with the token or the timestamp, if the timestamp is in
    the past.

  * <ChangestreamInvalidEvents />
</Important>

<Tabs tabset="drivers">
  <Tab tabid="c">
    C

    In the example below, the `resumeAfter` option is appended to the stream options
    to recreate the stream after it has been destroyed. Passing the `_id` to
    the change stream attempts to resume notifications starting after the
    operation specified.

    ```C
    // Source: /driver-examples/test-mongoc-sample-commands.c
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="csharp">
    C#

    In the example below, the `resumeToken` is retrieved from the last change stream document
    and passed to the `Watch()` method as an option. Passing the `resumeToken`
    to the `Watch()` method directs
    the change stream to attempt to resume notifications starting after the
    operation specified in the resume token.

    ```csharp
    // Source: /driver-examples/ChangeStreamExamples.cs
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="go">
    Go

    You can use [ChangeStreamOptions.SetResumeAfter](https://godoc.org/go.mongodb.org/mongo-driver/mongo/options#ChangeStreamOptions.SetResumeAfter)
    to specify the resume
    token for the change stream. If the resumeAfter option is set,
    the change stream resumes notifications after the operation
    specified in the resume token. The `SetResumeAfter` takes a
    value that must resolve to a resume token, e.g.
    `resumeToken` in the example below.

    ```go
    // Source: /driver-examples/go_examples.go
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="java-sync">
    Java (Sync)

    You can use the `resumeAfter()` method to resume
    notifications after the operation specified in the resume
    token. The `resumeAfter()` method takes a value that must
    resolve to a resume token, e.g. `resumeToken` in the
    example below.

    ```java
    // Source: /driver-examples/DocumentationSamples.java
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="kotlin-coroutine">
    Kotlin (Coroutine)

    You can use the [ChangeStreamFlow.resumeAfter()](https://mongodb.github.io/mongo-java-driver/4.11/apidocs/mongodb-driver-kotlin-coroutine/mongodb-driver-kotlin-coroutine/com.mongodb.kotlin.client.coroutine/-change-stream-flow/resume-after.html)
    method to resume notifications after the operation specified in the resume
    token. The `resumeAfter()` method takes a value that must
    resolve to a resume token, such as the `resumeToken` variable in the
    example below.

    ```kotlin
    // Source: /driver-examples/kotlin_examples.kt
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="motor">
    Motor

    You can use the `resume_after` modifier to resume
    notifications after the operation specified in the resume
    token. The `resume_after` modifier takes a value that must
    resolve to a resume token, e.g. `resume_token` in the
    example below.

    ```python
    // Source: /driver-examples/test_examples_motor.py
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="nodejs">
    Node.js

    You can use the `resumeAfter` option to resume
    notifications after the operation specified in the resume
    token. The `resumeAfter` option takes a value that must
    resolve to a resume token, e.g. `resumeToken` in the
    example below.

    ```javascript
    // Source: /driver-examples/node_changestreams.js
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="php">
    PHP

    You can use the `resumeAfter` option to resume
    notifications after the operation specified in the resume
    token. The `resumeAfter` option takes a value that must
    resolve to a resume token, e.g. `$resumeToken` in the
    example below.

    ```php
    // Source: /driver-examples/DocumentationExamplesTest.php
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="python">
    Python

    You can use the `resume_after` modifier to resume
    notifications after the operation specified in the resume
    token. The `resume_after` modifier takes a value that must
    resolve to a resume token, e.g. `resume_token` in the
    example below.

    ```python
    // Source: /driver-examples/test_examples.py
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="ruby">
    Ruby

    You can use the `resume_after` modifier to resume
    notifications after the operation specified in the resume
    token. The `resume_after` modifier takes a value that must
    resolve to a resume token, e.g. `resume_token` in the
    example below.

    ```ruby
    // Source: /driver-examples/change_stream_examples_spec.rb
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="swift-async">
    Swift (Async)

    You can use the `resumeAfter` option to resume
    notifications after the operation specified in the resume
    token. The `resumeAfter` option takes a value that must
    resolve to a resume token, e.g. `resumeToken` in the
    example below.

    ```swift
    // Source: /driver-examples/swiftAsync.swift
    // TODO: Content from external file not available during conversion
    ```
  </Tab>

  <Tab tabid="swift-sync">
    Swift (Sync)

    You can use the `resumeAfter` option to resume
    notifications after the operation specified in the resume
    token. The `resumeAfter` option takes a value that must
    resolve to a resume token, e.g. `resumeToken` in the
    example below.

    ```swift
    // Source: /driver-examples/swiftSync.swift
    // TODO: Content from external file not available during conversion
    ```
  </Tab>
</Tabs>

<span id="std-label-change-stream-start-after" />

### `startAfter` for Change Streams

You can start a new change stream after a specific event by passing a resume
token to `startAfter` when opening the cursor. Unlike
<Ref url="change-stream-resume-after">resumeAfter</Ref>, `startAfter` can
resume notifications after an <Ref url="change-event-invalidate">invalidate event</Ref>
by creating a new change stream.

See <Ref url="change-stream-resume-token">Resume Tokens</Ref> for more information on the resume token.

<Important>
  * The oplog must have enough history to locate the operation
    associated with the token or the timestamp, if the timestamp is in
    the past.
</Important>

<span id="std-label-change-stream-resume-token" />

### Resume Tokens

The resume token is available from multiple sources:

<ListTable header-rows={{"$numberInt":"1"}} stub-columns={{"$numberInt":"1"}} widths="20 80">
  * * Source

    * Description

  * * <Ref url="change-event-resume-token">Change Events</Ref>

    * Each change event notification includes a resume token
      on the `_id` field.

  * * <Ref url="aggregate-resume-token">Aggregation</Ref>

    * The <Ref url="pipe.$changeStream">`$changeStream`</Ref> aggregation stage includes
      a resume token on the `cursor.postBatchResumeToken` field.

      This field only appears when using the <Ref url="dbcmd.aggregate">`aggregate`</Ref>
      command.

  * * <Ref url="getMore-resume-token">Get More</Ref>

    * The <Ref url="dbcmd.getMore">`getMore`</Ref> command includes a resume token on the
      `cursor.postBatchResumeToken` field.
</ListTable>

<_4_2ChangesChangeStreamModificationError />

<Tip>
  <NoteDecodeResumeTokens />
</Tip>

<span id="std-label-change-event-resume-token" />

#### Resume Tokens from Change Events

Change event notifications include a resume token on the `_id` field:

```json
{
   "_id": {
      "_data": "82635019A0000000012B042C0100296E5A1004AB1154ACACD849A48C61756D70D3B21F463C6F7065726174696F6E54797065003C696E736572740046646F63756D656E744B65790046645F69640064635019A078BE67426D7CF4D2000004"
    },
    "operationType": "insert",
    "clusterTime": Timestamp({ "t": 1666193824, "i": 1 }),
    "collectionUUID": new UUID("ab1154ac-acd8-49a4-8c61-756d70d3b21f"),
    "wallTime": ISODate("2022-10-19T15:37:04.604Z"),
    "fullDocument": {
       "_id": ObjectId("635019a078be67426d7cf4d2"'),
       "name": "Giovanni Verga"
    },
    "ns": {
       "db": "test",
       "coll": "names"
    },
    "documentKey": {
       "_id": ObjectId("635019a078be67426d7cf4d2")
    }
}
```

<span id="std-label-aggregate-resume-token" />

#### Resume Tokens from `aggregate`

When using the <Ref url="dbcmd.aggregate">`aggregate`</Ref> command, the <Ref url="pipe.$changeStream">`$changeStream`</Ref>
aggregation stage includes a resume token on the
`cursor.postBatchResumeToken` field:

```json
{
   "cursor": {
      "firstBatch": [],
      "postBatchResumeToken": {
         "_data": "8263515EAC000000022B0429296E1404"
      },
      "id": Long("4309380460777152828"),
      "ns": "test.names"
   },
   "ok": 1,
   "$clusterTime": {
      "clusterTime": Timestamp({ "t": 1666277036, "i": 1 }),
      "signature": {
         "hash": Binary(Buffer.from("0000000000000000000000000000000000000000", "hex"), 0),
         "keyId": Long("0")
      }
   },
   "operationTime": Timestamp({ "t": 1666277036, "i": 1 })
}
```

<span id="std-label-getMore-resume-token" />

#### Resume Tokens from `getMore`

The <Ref url="dbcmd.getMore">`getMore`</Ref> command also includes a resume token on the
`cursor.postBatchResumeToken` field:

```json
{
   "cursor": {
      "nextBatch": [],
      "postBatchResumeToken": {
         "_data": "8263515979000000022B0429296E1404"
      },
      "id": Long("7049907285270685005"),
      "ns": "test.names"
   },
   "ok": 1,
   "$clusterTime": {
      "clusterTime": Timestamp( { "t": 1666275705, "i": 1 } ),
      "signature": {
         "hash": Binary(Buffer.from("0000000000000000000000000000000000000000", "hex"), 0),
         "keyId": Long("0")
      }
   },
   "operationTime": Timestamp({ "t": 1666275705, "i": 1 })
}
```

## Use Cases

Change streams can benefit architectures with reliant business systems,
informing downstream systems once data changes are durable. For example,
change streams can save time for developers when implementing Extract,
Transform, and Load (ETL) services, cross-platform synchronization,
collaboration functionality, and notification services.

<span id="std-label-change-streams-access" />

## Access Control

For deployments enforcing <Ref url="authentication">Authentication on Self-Managed Deployments</Ref> and <Ref url="authorization">authorization</Ref>:

* To open a change stream against specific collection, applications
  must have privileges that grant <Ref url="changeStream">`changeStream`</Ref> and
  <Ref url="find">`find`</Ref> actions on the corresponding collection.

  ```javascript
  { resource: { db: <dbname>, collection: <collection> }, actions: [ "find", "changeStream" ] }
  ```

* To open a change stream on a single database, applications must have
  privileges that grant <Ref url="changeStream">`changeStream`</Ref> and
  <Ref url="find">`find`</Ref> actions on all non-`system` collections in the
  database.

  ```javascript
  { resource: { db: <dbname>, collection: "" }, actions: [ "find", "changeStream" ] }
  ```

* To open a change stream on an entire deployment, applications must
  have privileges that grant <Ref url="changeStream">`changeStream`</Ref> and
  <Ref url="find">`find`</Ref> actions on all non-`system` collections for all
  databases in the deployment.

  ```javascript
  { resource: { db: "", collection: "" }, actions: [ "find", "changeStream" ] }
  ```

<span id="std-label-change-streams-event-notification" />

## Event Notification

Change streams only notify on data changes that have persisted to a majority
of data-bearing members in the replica set. This ensures that notifications are
triggered only by majority-committed changes that are durable in failure
scenarios.

For example, consider a 3-member <Ref url="replica set">replica set</Ref> with a change stream
cursor opened against the <Ref url="primary">primary</Ref>. If a client issues an insert
operation, the change stream only notifies the application of the data change
once that insert has persisted to a majority of data-bearing members.

If an operation is associated with a transaction, the change event document includes the
`txnNumber` and the `lsid`.

## Collation

Change streams use `simple` binary comparisons unless an explicit collation is
provided.

## Change Streams and Orphan Documents

<ChangeStreamsAndOrphans />

<span id="std-label-change-stream-pre-post-images" />

## Change Streams with Document Pre- and Post-Images

<ChangeStreamPreAndPostImagesIntroduction />

<ChangeStreamPreAndPostImagesAdditionalInformation />

For complete examples with the change stream output, see
<Ref url="db.collection.watch-change-streams-pre-and-post-images-example">Change Streams with Document Pre- and Post-Images</Ref>.

<Toctree titlesonly={true} hidden={true} />
