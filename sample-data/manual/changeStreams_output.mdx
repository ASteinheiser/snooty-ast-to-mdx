---
selectors: {"drivers":{"c":[{"type":"text","position":{"start":{"line":{"$numberInt":"189"}}},"value":"C"}],"csharp":[{"type":"text","position":{"start":{"line":{"$numberInt":"189"}}},"value":"C#"}],"go":[{"type":"text","position":{"start":{"line":{"$numberInt":"189"}}},"value":"Go"}],"java-sync":[{"type":"text","position":{"start":{"line":{"$numberInt":"189"}}},"value":"Java (Sync)"}],"kotlin-coroutine":[{"type":"text","position":{"start":{"line":{"$numberInt":"189"}}},"value":"Kotlin (Coroutine)"}],"motor":[{"type":"text","position":{"start":{"line":{"$numberInt":"189"}}},"value":"Motor"}],"nodejs":[{"type":"text","position":{"start":{"line":{"$numberInt":"189"}}},"value":"Node.js"}],"php":[{"type":"text","position":{"start":{"line":{"$numberInt":"189"}}},"value":"PHP"}],"python":[{"type":"text","position":{"start":{"line":{"$numberInt":"189"}}},"value":"Python"}],"ruby":[{"type":"text","position":{"start":{"line":{"$numberInt":"189"}}},"value":"Ruby"}],"swift-async":[{"type":"text","position":{"start":{"line":{"$numberInt":"189"}}},"value":"Swift (Async)"}],"swift-sync":[{"type":"text","position":{"start":{"line":{"$numberInt":"189"}}},"value":"Swift (Sync)"}]}}
headings: [{"depth":{"$numberInt":"2"},"id":"availability","title":[{"type":"text","position":{"start":{"line":{"$numberInt":"40"}}},"value":"Availability"}],"selector_ids":{}},{"depth":{"$numberInt":"2"},"id":"connect","title":[{"type":"text","position":{"start":{"line":{"$numberInt":"67"}}},"value":"Connect"}],"selector_ids":{}},{"depth":{"$numberInt":"2"},"id":"watch-a-collection--database--or-deployment","title":[{"type":"text","position":{"start":{"line":{"$numberInt":"84"}}},"value":"Watch a Collection, Database, or Deployment"}],"selector_ids":{}},{"depth":{"$numberInt":"2"},"id":"change-stream-performance-considerations","title":[{"type":"text","position":{"start":{"line":{"$numberInt":"135"}}},"value":"Change Stream Performance Considerations"}],"selector_ids":{}},{"depth":{"$numberInt":"2"},"id":"open-a-change-stream","title":[{"type":"text","position":{"start":{"line":{"$numberInt":"164"}}},"value":"Open A Change Stream"}],"selector_ids":{}},{"depth":{"$numberInt":"2"},"id":"modify-change-stream-output","title":[{"type":"text","position":{"start":{"line":{"$numberInt":"383"}}},"value":"Modify Change Stream Output"}],"selector_ids":{}},{"depth":{"$numberInt":"2"},"id":"lookup-full-document-for-update-operations","title":[{"type":"text","position":{"start":{"line":{"$numberInt":"583"}}},"value":"Lookup Full Document for Update Operations"}],"selector_ids":{}},{"depth":{"$numberInt":"2"},"id":"resume-a-change-stream","title":[{"type":"text","position":{"start":{"line":{"$numberInt":"830"}}},"value":"Resume a Change Stream"}],"selector_ids":{}},{"depth":{"$numberInt":"2"},"id":"use-cases","title":[{"type":"text","position":{"start":{"line":{"$numberInt":"1200"}}},"value":"Use Cases"}],"selector_ids":{}},{"depth":{"$numberInt":"2"},"id":"access-control","title":[{"type":"text","position":{"start":{"line":{"$numberInt":"1211"}}},"value":"Access Control"}],"selector_ids":{}},{"depth":{"$numberInt":"2"},"id":"event-notification","title":[{"type":"text","position":{"start":{"line":{"$numberInt":"1245"}}},"value":"Event Notification"}],"selector_ids":{}},{"depth":{"$numberInt":"2"},"id":"collation","title":[{"type":"text","position":{"start":{"line":{"$numberInt":"1262"}}},"value":"Collation"}],"selector_ids":{}},{"depth":{"$numberInt":"2"},"id":"change-streams-and-orphan-documents","title":[{"type":"text","position":{"start":{"line":{"$numberInt":"1268"}}},"value":"Change Streams and Orphan Documents"}],"selector_ids":{}},{"depth":{"$numberInt":"2"},"id":"change-streams-with-document-pre--and-post-images","title":[{"type":"text","position":{"start":{"line":{"$numberInt":"1275"}}},"value":"Change Streams with Document Pre- and Post-Images"}],"selector_ids":{}}]
---

<span id="std-label-changeStreams" />

<span id="std-label-collection_watch" />

# Change Streams

<DefaultDomain>
  mongodb
</DefaultDomain>

<Facet name="genre" values="reference" />

<Contents local={true} backlinks="none" depth={{"$numberInt":"1"}} class="twocols">
  On this page
</Contents>

Change streams allow applications to access real-time data changes
without the prior complexity and risk of manually tailing the oplog.
Applications can use change streams to subscribe to all data changes on
a single collection, a database, or an entire deployment, and
immediately react to them. Because change streams use the aggregation
framework, applications can also filter for specific changes or
transform the notifications at will.

change streams

<Include href="/includes/change-streams-optimization.rst">
  Starting in MongoDB 5.1, <SubstitutionReference>change streams</SubstitutionReference> are optimized, providing more
  efficient resource utilization and faster execution of some aggregation
  pipeline stages.
</Include>

## Availability

Change streams are available for replica sets and
sharded clusters:

* **Storage Engine.**

  The replica sets and sharded clusters must use the WiredTiger storage engine. Change streams can also be used
  on deployments that employ MongoDB's
  encryption-at-rest feature.

* **Replica Set Protocol Version.**

  The replica sets and sharded clusters must use replica set protocol
  version 1 (`pv1`).

* **Read Concern "majority" Enablement.**

  <Include href="/includes/extracts/changestream-rc-majority-4.2.rst">
    <Extract>
      Change streams are
      available regardless of the `"majority"` read concern
      support; that is, read concern `majority` support can be either
      enabled (default) or disabled
      to use change streams.
    </Extract>
  </Include>

### Stable API Support

<Include href="/includes/stable-api/change-stream-support.rst">
  Change streams are included in Stable API V1.
  However, the showExpandedEvents
  option is not included in Stable API V1.
</Include>

## Connect

Connections for a change stream can either use DNS seed lists
with the `+srv` connection option or by listing the servers individually
in the connection string.

If the driver loses the connection to a change stream or the connection goes
down, it attempts to reestablish a connection to the change stream through
another node in the cluster that has a matching
read preference. If the driver cannot find
a node with the correct read preference, it throws an exception.

For more information, see Connection String URI Format.

<span id="std-label-changeStreams-watch-deployment" />

## Watch a Collection, Database, or Deployment

You can open change streams against:

<ListTable header-rows={{"$numberInt":"1"}} widths="15 85">
  * * Target

    * Description

  * * A collection

    * You can open a change stream cursor for a single collection
      (except `system` collections, or any collections in the
      `admin`, `local`, and `config` databases).

      The examples on this page use the MongoDB drivers to open and
      work with a change stream cursor for a single collection. See
      also the [`mongosh`](https://www.mongodb.com/docs/mongodb-shell/#mongodb-binary-bin.mongosh) method
      `db.collection.watch()`.

  * * A database

    * You can open a change stream cursor for a single database (excluding
      `admin`, `local`, and `config` database) to watch for changes to
      all its non-system collections.

      For the MongoDB driver method, refer to your driver
      documentation. See also the [`mongosh`](https://www.mongodb.com/docs/mongodb-shell/#mongodb-binary-bin.mongosh) method
      `db.watch()`.

  * * A deployment

    * You can open a change stream cursor for a deployment (either a replica
      set or a sharded cluster) to watch for changes to all non-system
      collections across all databases except for `admin`, `local`, and
      `config`.

      For the MongoDB driver method, refer to your driver
      documentation. See also the [`mongosh`](https://www.mongodb.com/docs/mongodb-shell/#mongodb-binary-bin.mongosh) method
      `Mongo.watch()`.
</ListTable>

<Note>
  Change Stream Examples

  The examples on this page use the MongoDB drivers to illustrate how
  to open a change stream cursor for a collection and work with the
  change stream cursor.
</Note>

## Change Stream Performance Considerations

If the amount of active change streams opened against a database exceeds the
connection pool size, you may
experience notification latency. Each change stream uses a connection
and a getMore
operation on the change stream for the period of time that it waits for the next event.
To avoid any latency issues, you should ensure that the pool size is greater than the
number of opened change streams. For details see the maxPoolSize setting.

### Sharded Cluster Considerations

When a change stream is opened on a sharded cluster:

* The `mongos` creates individual change streams on **each
  shard**. This behavior occurs regardless of whether the change stream
  targets a particular shard key range.

* When the `mongos` receives change stream results, it sorts and
  filters those results. If needed, the `mongos` also performs a
  `fullDocument` lookup.

For best performance, limit the use of `$lookup` queries in
change streams.

<span id="std-label-open-change-stream" />

## Open A Change Stream

To open a change stream:

* For a replica set, you can issue the open change stream operation
  from any of the data-bearing members.

* For a sharded cluster, you must issue the open change stream
  operation from the `mongos`.

The following example opens a change stream for a collection and
iterates over the cursor to retrieve the change stream documents.
[^start-time]

***

➤

<SubstitutionReference>➤</SubstitutionReference> Use the **Select your language** drop-down menu in the
upper-right to set the language of the examples on this page.

***

<TabsSelector>
  drivers
</TabsSelector>

<Tabs tabset="drivers">
  <Tab tabid="c">
    C

    The C examples below assume that you have [connected to a MongoDB replica set and have accessed a database](https://www.mongodb.com/docs/languages/c/c-driver/current/databases-collections/#access-a-database)
    that contains an `inventory` collection.

    <Literalinclude language="c" dedent={{"$numberInt":"3"}} start-after="Start Changestream Example 1" end-before="End Changestream Example 1">
      /driver-examples/test-mongoc-sample-commands.c
    </Literalinclude>
  </Tab>

  <Tab tabid="csharp">
    C#

    The C# examples below assume that you have [connected to a MongoDB replica set and have accessed a database](http://mongodb.github.io/mongo-csharp-driver/2.4/getting_started/quick_tour/#make-a-connection/)
    that contains an `inventory` collection.

    <Literalinclude language="csharp" dedent={{"$numberInt":"12"}} start-after="Start Changestream Example 1" end-before="End Changestream Example 1">
      /driver-examples/ChangeStreamExamples.cs
    </Literalinclude>
  </Tab>

  <Tab tabid="go">
    Go

    The Go examples below assume that you have [connected to a MongoDB replica set and have accessed a database](https://godoc.org/go.mongodb.org/mongo-driver/mongo#NewClient/)
    that contains an `inventory` collection.

    <Literalinclude language="go" dedent={{"$numberInt":"2"}} start-after="Start Changestream Example 1" end-before="End Changestream Example 1">
      /driver-examples/go\_examples.go
    </Literalinclude>
  </Tab>

  <Tab tabid="java-sync">
    Java (Sync)

    The Java examples below assume that you have [connected to a MongoDB replica set and have accessed a database](http://mongodb.github.io/mongo-java-driver/3.6/driver/tutorials/databases-collections/)
    that contains an `inventory` collection.

    <Literalinclude language="java" dedent={{"$numberInt":"8"}} start-after="Start Changestream Example 1" end-before="End Changestream Example 1">
      /driver-examples/DocumentationSamples.java
    </Literalinclude>
  </Tab>

  <Tab tabid="kotlin-coroutine">
    Kotlin (Coroutine)

    The Kotlin examples below assume that you are connected to a MongoDB replica set and can access a database
    that contains the `inventory` collection. To learn more about completing these tasks, see the
    [Kotlin Coroutine Driver Databases and Collections](https://www.mongodb.com/docs/drivers/kotlin/coroutine/current/fundamentals/databases-collections/) guide.

    <Literalinclude language="kotlin" dedent={true} start-after="Start Changestream Example 1" end-before="End Changestream Example 1">
      /driver-examples/kotlin\_examples.kt
    </Literalinclude>
  </Tab>

  <Tab tabid="motor">
    Motor

    The examples below assume that you have [connected to a MongoDB replica set and have accessed a database](https://motor.readthedocs.io/en/stable/tutorial-asyncio.html#creating-a-client)
    that contains an `inventory` collection.

    <Literalinclude language="python" dedent={{"$numberInt":"12"}} start-after="Start Changestream Example 1" end-before="End Changestream Example 1">
      /driver-examples/test\_examples\_motor.py
    </Literalinclude>
  </Tab>

  <Tab tabid="nodejs">
    Node.js

    The Node.js examples below assume that you have [connected to a MongoDB replica set and have accessed a database](https://mongodb.github.io/node-mongodb-native/api-generated/mongoclient.html#connect)
    that contains an `inventory` collection.

    The following example uses stream to process the change events.

    <Literalinclude language="javascript" dedent={{"$numberInt":"6"}} start-after="Start Changestream Example 1" end-before="End Changestream Example 1">
      /driver-examples/node\_changestreams.js
    </Literalinclude>

    Alternatively, you can also use iterator to process the change events:

    <Literalinclude language="javascript" dedent={{"$numberInt":"6"}} start-after="Start Changestream Example 1 Alternative" end-before="End Changestream Example 1 Alternative">
      /driver-examples/node\_changestreams.js
    </Literalinclude>

    ChangeStream extends [EventEmitter](https://mongodb.github.io/node-mongodb-native/5.7/classes/TypedEventEmitter.html).
  </Tab>

  <Tab tabid="php">
    PHP

    The examples below assume that you have [connected to a MongoDB replica  set and have accessed a database](https://www.mongodb.com/docs/php-library/current/reference/method/MongoDBClient__construct/)
    that contains an `inventory` collection.

    <Literalinclude language="php" dedent={{"$numberInt":"8"}} start-after="Start Changestream Example 1" end-before="End Changestream Example 1">
      /driver-examples/DocumentationExamplesTest.php
    </Literalinclude>
  </Tab>

  <Tab tabid="python">
    Python

    The Python examples below assume that you have [connected to a MongoDB replica set and have accessed a database](https://www.mongodb.com/docs/drivers/pymongo/) that contains an `inventory` collection.

    <Literalinclude language="python" dedent={{"$numberInt":"12"}} start-after="Start Changestream Example 1" end-before="End Changestream Example 1">
      /driver-examples/test\_examples.py
    </Literalinclude>
  </Tab>

  <Tab tabid="ruby">
    Ruby

    The examples below assume that you have [connected to a MongoDB replica set and have accessed a database](https://www.mongodb.com/docs/ruby-driver/current/reference/create-client/)
    that contains an `inventory` collection.

    <Literalinclude language="ruby" dedent={{"$numberInt":"8"}} start-after="Start Changestream Example 1" end-before="End Changestream Example 1">
      /driver-examples/change\_stream\_examples\_spec.rb
    </Literalinclude>
  </Tab>

  <Tab tabid="swift-async">
    Swift (Async)

    The Swift (Async) examples below assume that you have
    [connected to a MongoDB replica set and have accessed a
    database](https://mongodb.github.io/mongo-swift-driver/docs/current/MongoSwift/Classes/MongoClient.html)
    that contains an `inventory` collection.

    <Literalinclude language="swift" dedent={{"$numberInt":"8"}} start-after="Start Changestream Example 1" end-before="End Changestream Example 1">
      /driver-examples/swiftAsync.swift
    </Literalinclude>
  </Tab>

  <Tab tabid="swift-sync">
    Swift (Sync)

    The Swift (Sync) examples below assume that you have
    [connected to a MongoDB replica set and have accessed a
    database](https://mongodb.github.io/mongo-swift-driver/docs/current/MongoSwiftSync/Classes/MongoClient.html)
    that contains an `inventory` collection.

    <Literalinclude language="swift" dedent={{"$numberInt":"8"}} start-after="Start Changestream Example 1" end-before="End Changestream Example 1">
      /driver-examples/swiftSync.swift
    </Literalinclude>
  </Tab>
</Tabs>

To retrieve the data change event from
the cursor, iterate the change stream cursor. For information on the
change stream event, see Change Events.

<Include href="/includes/extracts/changestream-cursor-open.rst">
  <Extract>
    The change stream cursor remains open until
    one of the following occurs:

    * The cursor is explicitly closed.

    * An invalidate event occurs; for
      example, a collection drop or rename.

    * The connection to the MongoDB deployment closes or times out.
      See Behavior for more information.

    * <Include href="/includes/extracts/changestream-remove-shard.rst">
        <Extract>
          If the deployment is a sharded cluster, a shard removal may cause an
          open change stream cursor to close. The closed change stream cursor
          may not be fully resumable.
        </Extract>
      </Include>
  </Extract>
</Include>

<Note>
  The lifecycle of an unclosed cursor is language-dependent.
</Note>

[^start-time]: You can specify a `startAtOperationTime` to open the cursor at a particular
    point in time. If the specified starting point is in the past, it must be in
    the time range of the oplog.

<span id="std-label-change-stream-modify-output" />

## Modify Change Stream Output

***

<SubstitutionReference>➤</SubstitutionReference> Use the **Select your language** drop-down menu in the
upper-right to set the language of the examples on this page.

***

<Tabs tabset="drivers">
  <Tab tabid="c">
    C

    <Include href="/includes/fact-change-streams-modify-output.rst">
      You can control change stream output by
      providing an array of one or more of the following pipeline stages when
      configuring the change stream:

      <Include href="/includes/extracts/changestream-available-pipeline-stages.rst">
        <Extract>
          * `$addFields`

          * `$match`

          * `$project`

          * `$replaceRoot`

          * `$replaceWith`

          * `$redact`

          * `$set`

          * `$unset`
        </Extract>
      </Include>
    </Include>

    <Literalinclude language="c" dedent={{"$numberInt":"3"}} start-after="Start Changestream Example 4" end-before="End Changestream Example 4">
      /driver-examples/test-mongoc-sample-commands.c
    </Literalinclude>
  </Tab>

  <Tab tabid="csharp">
    C#

    <Include href="/includes/fact-change-streams-modify-output.rst">
      You can control change stream output by
      providing an array of one or more of the following pipeline stages when
      configuring the change stream:

      <Include href="/includes/extracts/changestream-available-pipeline-stages.rst">
        <Extract>
          * `$addFields`

          * `$match`

          * `$project`

          * `$replaceRoot`

          * `$replaceWith`

          * `$redact`

          * `$set`

          * `$unset`
        </Extract>
      </Include>
    </Include>

    <Literalinclude language="csharp" dedent={{"$numberInt":"16"}} start-after="Start Changestream Example 4" end-before="End Changestream Example 4">
      /driver-examples/ChangeStreamExamples.cs
    </Literalinclude>
  </Tab>

  <Tab tabid="go">
    Go

    <Include href="/includes/fact-change-streams-modify-output.rst">
      You can control change stream output by
      providing an array of one or more of the following pipeline stages when
      configuring the change stream:

      <Include href="/includes/extracts/changestream-available-pipeline-stages.rst">
        <Extract>
          * `$addFields`

          * `$match`

          * `$project`

          * `$replaceRoot`

          * `$replaceWith`

          * `$redact`

          * `$set`

          * `$unset`
        </Extract>
      </Include>
    </Include>

    <Literalinclude language="go" dedent={{"$numberInt":"2"}} start-after="Start Changestream Example 4" end-before="End Changestream Example 4">
      /driver-examples/go\_examples.go
    </Literalinclude>
  </Tab>

  <Tab tabid="java-sync">
    Java (Sync)

    <Include href="/includes/fact-change-streams-modify-output.rst">
      You can control change stream output by
      providing an array of one or more of the following pipeline stages when
      configuring the change stream:

      <Include href="/includes/extracts/changestream-available-pipeline-stages.rst">
        <Extract>
          * `$addFields`

          * `$match`

          * `$project`

          * `$replaceRoot`

          * `$replaceWith`

          * `$redact`

          * `$set`

          * `$unset`
        </Extract>
      </Include>
    </Include>

    ```java
    MongoClient mongoClient = MongoClients.create("mongodb://<username>:<password>@<host>:<port>");

    // Select the MongoDB database and collection to open the change stream against

    MongoDatabase db = mongoClient.getDatabase("myTargetDatabase");

    MongoCollection<Document> collection = db.getCollection("myTargetCollection");

    // Create $match pipeline stage.
    List<Bson> pipeline = singletonList(Aggregates.match(Filters.or(
       Document.parse("{'fullDocument.username': 'alice'}"),
       Filters.in("operationType", asList("delete")))));

    // Create the change stream cursor, passing the pipeline to the
    // collection.watch() method

    MongoCursor<Document> cursor = collection.watch(pipeline).iterator();
    ```

    The `pipeline` list includes a single `$match` stage that
    filters for any operations that meet one or both of the following criteria:

    * `username` value is `alice`

    * `operationType` value is `delete`

    Passing the `pipeline` to the `watch()` method directs the
    change stream to return notifications after passing them through the
    specified `pipeline`.
  </Tab>

  <Tab tabid="kotlin-coroutine">
    Kotlin (Coroutine)

    <Include href="/includes/fact-change-streams-modify-output.rst">
      You can control change stream output by
      providing an array of one or more of the following pipeline stages when
      configuring the change stream:

      <Include href="/includes/extracts/changestream-available-pipeline-stages.rst">
        <Extract>
          * `$addFields`

          * `$match`

          * `$project`

          * `$replaceRoot`

          * `$replaceWith`

          * `$redact`

          * `$set`

          * `$unset`
        </Extract>
      </Include>
    </Include>

    <Literalinclude language="kotlin" dedent={true} start-after="Start Changestream Example 4" end-before="End Changestream Example 4">
      /driver-examples/kotlin\_examples.kt
    </Literalinclude>

    The `pipeline` list includes a single `$match` stage that
    filters for any operations that meet one or both of the following criteria:

    * `username` value is `alice`

    * `operationType` value is `delete`

    Passing the `pipeline` to the `watch()` method directs the
    change stream to return notifications after passing them through the
    specified `pipeline`.
  </Tab>

  <Tab tabid="motor">
    Motor

    <Include href="/includes/fact-change-streams-modify-output.rst">
      You can control change stream output by
      providing an array of one or more of the following pipeline stages when
      configuring the change stream:

      <Include href="/includes/extracts/changestream-available-pipeline-stages.rst">
        <Extract>
          * `$addFields`

          * `$match`

          * `$project`

          * `$replaceRoot`

          * `$replaceWith`

          * `$redact`

          * `$set`

          * `$unset`
        </Extract>
      </Include>
    </Include>

    <Literalinclude language="python" dedent={{"$numberInt":"12"}} start-after="Start Changestream Example 4" end-before="End Changestream Example 4">
      /driver-examples/test\_examples\_motor.py
    </Literalinclude>
  </Tab>

  <Tab tabid="nodejs">
    Node.js

    <Include href="/includes/fact-change-streams-modify-output.rst">
      You can control change stream output by
      providing an array of one or more of the following pipeline stages when
      configuring the change stream:

      <Include href="/includes/extracts/changestream-available-pipeline-stages.rst">
        <Extract>
          * `$addFields`

          * `$match`

          * `$project`

          * `$replaceRoot`

          * `$replaceWith`

          * `$redact`

          * `$set`

          * `$unset`
        </Extract>
      </Include>
    </Include>

    The following example uses stream to process the change events.

    <Literalinclude language="javascript" dedent={{"$numberInt":"6"}} start-after="Start Changestream Example 4" end-before="End Changestream Example 4">
      /driver-examples/node\_changestreams.js
    </Literalinclude>

    Alternatively, you can also use iterator to process the change events:

    <Literalinclude language="javascript" dedent={{"$numberInt":"6"}} start-after="Start Changestream Example 4 Alternative" end-before="End Changestream Example 4 Alternative">
      /driver-examples/node\_changestreams.js
    </Literalinclude>
  </Tab>

  <Tab tabid="php">
    PHP

    <Include href="/includes/fact-change-streams-modify-output.rst">
      You can control change stream output by
      providing an array of one or more of the following pipeline stages when
      configuring the change stream:

      <Include href="/includes/extracts/changestream-available-pipeline-stages.rst">
        <Extract>
          * `$addFields`

          * `$match`

          * `$project`

          * `$replaceRoot`

          * `$replaceWith`

          * `$redact`

          * `$set`

          * `$unset`
        </Extract>
      </Include>
    </Include>

    <Literalinclude language="php" dedent={{"$numberInt":"8"}} start-after="Start Changestream Example 4" end-before="End Changestream Example 4">
      /driver-examples/DocumentationExamplesTest.php
    </Literalinclude>
  </Tab>

  <Tab tabid="python">
    Python

    <Include href="/includes/fact-change-streams-modify-output.rst">
      You can control change stream output by
      providing an array of one or more of the following pipeline stages when
      configuring the change stream:

      <Include href="/includes/extracts/changestream-available-pipeline-stages.rst">
        <Extract>
          * `$addFields`

          * `$match`

          * `$project`

          * `$replaceRoot`

          * `$replaceWith`

          * `$redact`

          * `$set`

          * `$unset`
        </Extract>
      </Include>
    </Include>

    <Literalinclude language="python" dedent={{"$numberInt":"12"}} start-after="Start Changestream Example 4" end-before="End Changestream Example 4">
      /driver-examples/test\_examples.py
    </Literalinclude>
  </Tab>

  <Tab tabid="ruby">
    Ruby

    <Include href="/includes/fact-change-streams-modify-output.rst">
      You can control change stream output by
      providing an array of one or more of the following pipeline stages when
      configuring the change stream:

      <Include href="/includes/extracts/changestream-available-pipeline-stages.rst">
        <Extract>
          * `$addFields`

          * `$match`

          * `$project`

          * `$replaceRoot`

          * `$replaceWith`

          * `$redact`

          * `$set`

          * `$unset`
        </Extract>
      </Include>
    </Include>
  </Tab>

  <Tab tabid="swift-async">
    Swift (Async)

    <Include href="/includes/fact-change-streams-modify-output.rst">
      You can control change stream output by
      providing an array of one or more of the following pipeline stages when
      configuring the change stream:

      <Include href="/includes/extracts/changestream-available-pipeline-stages.rst">
        <Extract>
          * `$addFields`

          * `$match`

          * `$project`

          * `$replaceRoot`

          * `$replaceWith`

          * `$redact`

          * `$set`

          * `$unset`
        </Extract>
      </Include>
    </Include>

    <Literalinclude language="swift" dedent={{"$numberInt":"8"}} start-after="Start Changestream Example 4" end-before="End Changestream Example 4">
      /driver-examples/swiftAsync.swift
    </Literalinclude>
  </Tab>

  <Tab tabid="swift-sync">
    Swift (Sync)

    <Include href="/includes/fact-change-streams-modify-output.rst">
      You can control change stream output by
      providing an array of one or more of the following pipeline stages when
      configuring the change stream:

      <Include href="/includes/extracts/changestream-available-pipeline-stages.rst">
        <Extract>
          * `$addFields`

          * `$match`

          * `$project`

          * `$replaceRoot`

          * `$replaceWith`

          * `$redact`

          * `$set`

          * `$unset`
        </Extract>
      </Include>
    </Include>

    <Literalinclude language="swift" dedent={{"$numberInt":"8"}} start-after="Start Changestream Example 4" end-before="End Changestream Example 4">
      /driver-examples/swiftSync.swift
    </Literalinclude>
  </Tab>
</Tabs>

<Tip>
  The \_id field of the change stream
  event document act as the resume token. Do not use the pipeline to modify or remove
  the change stream event's `_id` field.

  <Include href="/includes/extracts/4.2-changes-change-stream-modification-error.rst">
    <Extract>
      Starting in MongoDB 4.2, change streams will throw an exception if
      the change stream aggregation pipeline modifies an event's \_id field.
    </Extract>
  </Include>

  See Change Events for more information on the change stream
  response document format.
</Tip>

<span id="std-label-change-streams-updateLookup" />

## Lookup Full Document for Update Operations

By default, change streams only return the delta of fields during
the update operation. However, you can configure the change stream
to return the most current majority-committed version of the updated
document.

***

<SubstitutionReference>➤</SubstitutionReference> Use the **Select your language** drop-down menu in the
upper-right to set the language of the examples on this page.

***

<Tabs tabset="drivers">
  <Tab tabid="c">
    C

    To return the most current majority-committed version of the updated
    document, pass the `"fullDocument"` option with the `"updateLookup"` value to the
    `mongoc_collection_watch` method.

    In the example below, all update operations notifications
    include a `fullDocument` field that represents the *current*
    version of the document affected by the update operation.

    <Literalinclude language="c" dedent={{"$numberInt":"3"}} start-after="Start Changestream Example 2" end-before="End Changestream Example 2">
      /driver-examples/test-mongoc-sample-commands.c
    </Literalinclude>
  </Tab>

  <Tab tabid="csharp">
    C#

    To return the most current majority-committed version of the updated
    document, pass `"FullDocument = ChangeStreamFullDocumentOption.UpdateLookup"` to the
    `db.collection.watch()` method.

    In the example below, all update operations notifications
    include a `FullDocument` field that represents the *current*
    version of the document affected by the update operation.

    <Literalinclude language="csharp" dedent={{"$numberInt":"12"}} start-after="Start Changestream Example 2" end-before="End Changestream Example 2">
      /driver-examples/ChangeStreamExamples.cs
    </Literalinclude>
  </Tab>

  <Tab tabid="go">
    Go

    To return the most current majority-committed version of the
    updated document, `SetFullDocument(options.UpdateLookup)`
    change stream option.

    <Literalinclude language="go" dedent={{"$numberInt":"2"}} start-after="Start Changestream Example 2" end-before="End Changestream Example 2">
      /driver-examples/go\_examples.go
    </Literalinclude>
  </Tab>

  <Tab tabid="java-sync">
    Java (Sync)

    To return the most current majority-committed version of the updated
    document, pass `FullDocument.UPDATE_LOOKUP`  to the
    `db.collection.watch.fullDocument()` method.

    In the example below, all update operations notifications
    include a `FullDocument` field that represents the *current*
    version of the document affected by the update operation.

    <Literalinclude language="java" dedent={{"$numberInt":"8"}} start-after="Start Changestream Example 2" end-before="End Changestream Example 2">
      /driver-examples/DocumentationSamples.java
    </Literalinclude>
  </Tab>

  <Tab tabid="kotlin-coroutine">
    Kotlin (Coroutine)

    To return the most current majority-committed version of the updated
    document, pass `FullDocument.UPDATE_LOOKUP`  to the
    [ChangeStreamFlow.fullDocument()](https://mongodb.github.io/mongo-java-driver/4.11/apidocs/mongodb-driver-kotlin-coroutine/mongodb-driver-kotlin-coroutine/com.mongodb.kotlin.client.coroutine/-change-stream-flow/full-document.html) method.

    In the example below, all update operations notifications
    include a `FullDocument` field that represents the *current*
    version of the document affected by the update operation.

    <Literalinclude language="kotlin" dedent={true} start-after="Start Changestream Example 2" end-before="End Changestream Example 2">
      /driver-examples/kotlin\_examples.kt
    </Literalinclude>
  </Tab>

  <Tab tabid="motor">
    Motor

    To return the most current majority-committed version of the updated
    document, pass `full_document='updateLookup'` to the
    `db.collection.watch()` method.

    In the example below, all update operations notifications
    include a `` `full_document `` field that represents the *current*
    version of the document affected by the update operation.

    <Literalinclude language="python" dedent={{"$numberInt":"12"}} start-after="Start Changestream Example 2" end-before="End Changestream Example 2">
      /driver-examples/test\_examples\_motor.py
    </Literalinclude>
  </Tab>

  <Tab tabid="nodejs">
    Node.js

    To return the most current majority-committed version of the updated
    document, pass `{ fullDocument: 'updateLookup' }` to the
    `db.collection.watch()` method.

    In the example below, all update operations notifications
    include a `fullDocument` field that represents the *current*
    version of the document affected by the update operation.

    The following example uses stream to process the change events.

    <Literalinclude language="javascript" dedent={{"$numberInt":"6"}} start-after="Start Changestream Example 2" end-before="End Changestream Example 2">
      /driver-examples/node\_changestreams.js
    </Literalinclude>

    Alternatively, you can also use iterator to process the change events:

    <Literalinclude language="javascript" dedent={{"$numberInt":"6"}} start-after="Start Changestream Example 2 Alternative" end-before="End Changestream Example 2 Alternative">
      /driver-examples/node\_changestreams.js
    </Literalinclude>
  </Tab>

  <Tab tabid="php">
    PHP

    To return the most current
    majority-committed version of the updated document, pass
    `"fullDocument' => \MongoDB\Operation\ChangeStreamCommand::FULL_DOCUMENT_UPDATE_LOOKUP"`
    to the `db.watch()` method.

    In the example below, all update operations notifications
    include a `fullDocument` field that represents the *current*
    version of the document affected by the update operation.

    <Literalinclude language="php" dedent={{"$numberInt":"8"}} start-after="Start Changestream Example 2" end-before="End Changestream Example 2">
      /driver-examples/DocumentationExamplesTest.php
    </Literalinclude>
  </Tab>

  <Tab tabid="python">
    Python

    To return the most current majority-committed version of the updated
    document, pass `full_document='updateLookup'` to the
    `db.collection.watch()` method.

    In the example below, all update operations notifications
    include a `full_document` field that represents the *current*
    version of the document affected by the update operation.

    <Literalinclude language="python" dedent={{"$numberInt":"12"}} start-after="Start Changestream Example 2" end-before="End Changestream Example 2">
      /driver-examples/test\_examples.py
    </Literalinclude>
  </Tab>

  <Tab tabid="ruby">
    Ruby

    To return the most current majority-committed version of the updated
    document, pass `full_document: 'updateLookup'` to the
    `db.watch()` method.

    In the example below, all update operations notifications
    include a `full_document` field that represents the *current*
    version of the document affected by the update operation.

    <Literalinclude language="ruby" dedent={{"$numberInt":"8"}} start-after="Start Changestream Example 2" end-before="End Changestream Example 2">
      /driver-examples/change\_stream\_examples\_spec.rb
    </Literalinclude>
  </Tab>

  <Tab tabid="swift-async">
    Swift (Async)

    To return the most current majority-committed version of
    the updated document, pass `options:
    ChangeStreamOptions(fullDocument: .updateLookup)` to the
    `watch()` method.

    <Literalinclude language="swift" dedent={{"$numberInt":"8"}} start-after="Start Changestream Example 2" end-before="End Changestream Example 2">
      /driver-examples/swiftAsync.swift
    </Literalinclude>
  </Tab>

  <Tab tabid="swift-sync">
    Swift (Sync)

    To return the most current majority-committed version of
    the updated document, pass `options:
    ChangeStreamOptions(fullDocument: .updateLookup)` to the
    `watch()` method.

    <Literalinclude language="swift" dedent={{"$numberInt":"8"}} start-after="Start Changestream Example 2" end-before="End Changestream Example 2">
      /driver-examples/swiftSync.swift
    </Literalinclude>
  </Tab>
</Tabs>

<Note>
  If there are one or more majority-committed operations that modified
  the updated document *after* the update operation but *before* the
  lookup, the full document returned may differ significantly from the
  document at the time of the update operation.

  However, the deltas included in the change stream document always
  correctly describe the watched collection changes that applied to
  that change stream event.

  The `fullDocument` field for an update event may be missing if one
  of the following is true:

  * If the document is deleted or if the collection is dropped in
    between the update and the lookup.

  * If the update changes the values for at least one of the fields in
    that collection's shard key.

  See Change Events for more information on the change
  stream response document format.
</Note>

<span id="std-label-change-stream-resume" />

## Resume a Change Stream

Change streams are resumable by specifying a resume token to either
resumeAfter or
startAfter when opening the cursor.

<span id="std-label-change-stream-resume-after" />

### `resumeAfter` for Change Streams

You can resume a change stream after a specific event by passing a resume token
to `resumeAfter` when opening the cursor.

See Resume Tokens for more information on the resume token.

<Important>
  * The oplog must have enough history to locate the operation
    associated with the token or the timestamp, if the timestamp is in
    the past.

  * <Include href="/includes/extracts/changestream-invalid-events.rst">
      <Extract>
        You cannot use `resumeAfter` to resume a change stream after an
        invalidate event (for example, a collection
        drop or rename) closes the stream. Instead, you can use
        startAfter to start a new change
        stream after an invalidate event.
      </Extract>
    </Include>
</Important>

<Tabs tabset="drivers">
  <Tab tabid="c">
    C

    In the example below, the `resumeAfter` option is appended to the stream options
    to recreate the stream after it has been destroyed. Passing the `_id` to
    the change stream attempts to resume notifications starting after the
    operation specified.

    <Literalinclude language="C" dedent={{"$numberInt":"3"}} start-after="Start Changestream Example 3" end-before="End Changestream Example 3">
      /driver-examples/test-mongoc-sample-commands.c
    </Literalinclude>
  </Tab>

  <Tab tabid="csharp">
    C#

    In the example below, the `resumeToken` is retrieved from the last change stream document
    and passed to the `Watch()` method as an option. Passing the `resumeToken`
    to the `Watch()` method directs
    the change stream to attempt to resume notifications starting after the
    operation specified in the resume token.

    <Literalinclude language="csharp" dedent={{"$numberInt":"14"}} start-after="Start Changestream Example 3" end-before="End Changestream Example 3">
      /driver-examples/ChangeStreamExamples.cs
    </Literalinclude>
  </Tab>

  <Tab tabid="go">
    Go

    You can use [ChangeStreamOptions.SetResumeAfter](https://godoc.org/go.mongodb.org/mongo-driver/mongo/options#ChangeStreamOptions.SetResumeAfter)
    to specify the resume
    token for the change stream. If the resumeAfter option is set,
    the change stream resumes notifications after the operation
    specified in the resume token. The `SetResumeAfter` takes a
    value that must resolve to a resume token, e.g.
    `resumeToken` in the example below.

    <Literalinclude language="go" dedent={{"$numberInt":"2"}} start-after="Start Changestream Example 3" end-before="End Changestream Example 3">
      /driver-examples/go\_examples.go
    </Literalinclude>
  </Tab>

  <Tab tabid="java-sync">
    Java (Sync)

    You can use the `resumeAfter()` method to resume
    notifications after the operation specified in the resume
    token. The `resumeAfter()` method takes a value that must
    resolve to a resume token, e.g. `resumeToken` in the
    example below.

    <Literalinclude language="java" dedent={{"$numberInt":"8"}} start-after="Start Changestream Example 3" end-before="End Changestream Example 3">
      /driver-examples/DocumentationSamples.java
    </Literalinclude>
  </Tab>

  <Tab tabid="kotlin-coroutine">
    Kotlin (Coroutine)

    You can use the [ChangeStreamFlow.resumeAfter()](https://mongodb.github.io/mongo-java-driver/4.11/apidocs/mongodb-driver-kotlin-coroutine/mongodb-driver-kotlin-coroutine/com.mongodb.kotlin.client.coroutine/-change-stream-flow/resume-after.html)
    method to resume notifications after the operation specified in the resume
    token. The `resumeAfter()` method takes a value that must
    resolve to a resume token, such as the `resumeToken` variable in the
    example below.

    <Literalinclude language="kotlin" dedent={true} start-after="Start Changestream Example 3" end-before="End Changestream Example 3">
      /driver-examples/kotlin\_examples.kt
    </Literalinclude>
  </Tab>

  <Tab tabid="motor">
    Motor

    You can use the `resume_after` modifier to resume
    notifications after the operation specified in the resume
    token. The `resume_after` modifier takes a value that must
    resolve to a resume token, e.g. `resume_token` in the
    example below.

    <Literalinclude language="python" dedent={{"$numberInt":"12"}} start-after="Start Changestream Example 3" end-before="End Changestream Example 3">
      /driver-examples/test\_examples\_motor.py
    </Literalinclude>
  </Tab>

  <Tab tabid="nodejs">
    Node.js

    You can use the `resumeAfter` option to resume
    notifications after the operation specified in the resume
    token. The `resumeAfter` option takes a value that must
    resolve to a resume token, e.g. `resumeToken` in the
    example below.

    <Literalinclude language="javascript" dedent={{"$numberInt":"6"}} start-after="Start Changestream Example 3" end-before="End Changestream Example 3">
      /driver-examples/node\_changestreams.js
    </Literalinclude>
  </Tab>

  <Tab tabid="php">
    PHP

    You can use the `resumeAfter` option to resume
    notifications after the operation specified in the resume
    token. The `resumeAfter` option takes a value that must
    resolve to a resume token, e.g. `$resumeToken` in the
    example below.

    <Literalinclude language="php" dedent={{"$numberInt":"8"}} start-after="Start Changestream Example 3" end-before="End Changestream Example 3">
      /driver-examples/DocumentationExamplesTest.php
    </Literalinclude>
  </Tab>

  <Tab tabid="python">
    Python

    You can use the `resume_after` modifier to resume
    notifications after the operation specified in the resume
    token. The `resume_after` modifier takes a value that must
    resolve to a resume token, e.g. `resume_token` in the
    example below.

    <Literalinclude language="python" dedent={{"$numberInt":"12"}} start-after="Start Changestream Example 3" end-before="End Changestream Example 3">
      /driver-examples/test\_examples.py
    </Literalinclude>
  </Tab>

  <Tab tabid="ruby">
    Ruby

    You can use the `resume_after` modifier to resume
    notifications after the operation specified in the resume
    token. The `resume_after` modifier takes a value that must
    resolve to a resume token, e.g. `resume_token` in the
    example below.

    <Literalinclude language="ruby" dedent={{"$numberInt":"6"}} start-after="Start Changestream Example 3" end-before="End Changestream Example 3">
      /driver-examples/change\_stream\_examples\_spec.rb
    </Literalinclude>
  </Tab>

  <Tab tabid="swift-async">
    Swift (Async)

    You can use the `resumeAfter` option to resume
    notifications after the operation specified in the resume
    token. The `resumeAfter` option takes a value that must
    resolve to a resume token, e.g. `resumeToken` in the
    example below.

    <Literalinclude language="swift" dedent={{"$numberInt":"8"}} start-after="Start Changestream Example 3" end-before="End Changestream Example 3">
      /driver-examples/swiftAsync.swift
    </Literalinclude>
  </Tab>

  <Tab tabid="swift-sync">
    Swift (Sync)

    You can use the `resumeAfter` option to resume
    notifications after the operation specified in the resume
    token. The `resumeAfter` option takes a value that must
    resolve to a resume token, e.g. `resumeToken` in the
    example below.

    <Literalinclude language="swift" dedent={{"$numberInt":"8"}} start-after="Start Changestream Example 3" end-before="End Changestream Example 3">
      /driver-examples/swiftSync.swift
    </Literalinclude>
  </Tab>
</Tabs>

<span id="std-label-change-stream-start-after" />

### `startAfter` for Change Streams

You can start a new change stream after a specific event by passing a resume
token to `startAfter` when opening the cursor. Unlike
resumeAfter, `startAfter` can
resume notifications after an invalidate event
by creating a new change stream.

See Resume Tokens for more information on the resume token.

<Important>
  * The oplog must have enough history to locate the operation
    associated with the token or the timestamp, if the timestamp is in
    the past.
</Important>

<span id="std-label-change-stream-resume-token" />

### Resume Tokens

The resume token is available from multiple sources:

<ListTable header-rows={{"$numberInt":"1"}} stub-columns={{"$numberInt":"1"}} widths="20 80">
  * * Source

    * Description

  * * Change Events

    * Each change event notification includes a resume token
      on the `_id` field.

  * * Aggregation

    * The `$changeStream` aggregation stage includes
      a resume token on the `cursor.postBatchResumeToken` field.

      This field only appears when using the `aggregate`
      command.

  * * Get More

    * The `getMore` command includes a resume token on the
      `cursor.postBatchResumeToken` field.
</ListTable>

<Include href="/includes/extracts/4.2-changes-change-stream-modification-error.rst">
  <Extract>
    Starting in MongoDB 4.2, change streams will throw an exception if
    the change stream aggregation pipeline modifies an event's \_id field.
  </Extract>
</Include>

<Tip>
  <Include href="/includes/note-decode-resume-tokens.rst">
    MongoDB provides a ["snippet"](https://www.mongodb.com/docs/mongodb-shell/snippets/#std-label-snip-overview), an
    extension to [`mongosh`](https://www.mongodb.com/docs/mongodb-shell/#mongodb-binary-bin.mongosh), that decodes hex-encoded
    resume tokens.

    You can install and run the [resumetoken](https://github.com/mongodb-labs/mongosh-snippets/tree/main/snippets/resumetoken)
    snippet from [`mongosh`](https://www.mongodb.com/docs/mongodb-shell/#mongodb-binary-bin.mongosh):

    ```javascript
    snippet install resumetoken
    decodeResumeToken('<RESUME TOKEN>')
    ```

    You can also run [resumetoken](https://github.com/mongodb-labs/mongosh-snippets/tree/main/snippets/resumetoken)
    from the command line (without using [`mongosh`](https://www.mongodb.com/docs/mongodb-shell/#mongodb-binary-bin.mongosh)) if `npm`
    is installed on your system:

    ```javascript
    npx mongodb-resumetoken-decoder <RESUME TOKEN>
    ```

    See the following for more details on:

    * [resumetoken](https://github.com/mongodb-labs/mongosh-snippets/tree/main/snippets/resumetoken)

    * [using snippets](https://www.mongodb.com/docs/mongodb-shell/snippets/working-with-snippets/#std-label-snip-using-snippets) in [`mongosh`](https://www.mongodb.com/docs/mongodb-shell/#mongodb-binary-bin.mongosh).
  </Include>
</Tip>

<span id="std-label-change-event-resume-token" />

#### Resume Tokens from Change Events

Change event notifications include a resume token on the `_id` field:

```json
{
   "_id": {
      "_data": "82635019A0000000012B042C0100296E5A1004AB1154ACACD849A48C61756D70D3B21F463C6F7065726174696F6E54797065003C696E736572740046646F63756D656E744B65790046645F69640064635019A078BE67426D7CF4D2000004"
    },
    "operationType": "insert",
    "clusterTime": Timestamp({ "t": 1666193824, "i": 1 }),
    "collectionUUID": new UUID("ab1154ac-acd8-49a4-8c61-756d70d3b21f"),
    "wallTime": ISODate("2022-10-19T15:37:04.604Z"),
    "fullDocument": {
       "_id": ObjectId("635019a078be67426d7cf4d2"'),
       "name": "Giovanni Verga"
    },
    "ns": {
       "db": "test",
       "coll": "names"
    },
    "documentKey": {
       "_id": ObjectId("635019a078be67426d7cf4d2")
    }
}
```

<span id="std-label-aggregate-resume-token" />

#### Resume Tokens from `aggregate`

When using the `aggregate` command, the `$changeStream`
aggregation stage includes a resume token on the
`cursor.postBatchResumeToken` field:

```json
{
   "cursor": {
      "firstBatch": [],
      "postBatchResumeToken": {
         "_data": "8263515EAC000000022B0429296E1404"
      },
      "id": Long("4309380460777152828"),
      "ns": "test.names"
   },
   "ok": 1,
   "$clusterTime": {
      "clusterTime": Timestamp({ "t": 1666277036, "i": 1 }),
      "signature": {
         "hash": Binary(Buffer.from("0000000000000000000000000000000000000000", "hex"), 0),
         "keyId": Long("0")
      }
   },
   "operationTime": Timestamp({ "t": 1666277036, "i": 1 })
}
```

<span id="std-label-getMore-resume-token" />

#### Resume Tokens from `getMore`

The `getMore` command also includes a resume token on the
`cursor.postBatchResumeToken` field:

```json
{
   "cursor": {
      "nextBatch": [],
      "postBatchResumeToken": {
         "_data": "8263515979000000022B0429296E1404"
      },
      "id": Long("7049907285270685005"),
      "ns": "test.names"
   },
   "ok": 1,
   "$clusterTime": {
      "clusterTime": Timestamp( { "t": 1666275705, "i": 1 } ),
      "signature": {
         "hash": Binary(Buffer.from("0000000000000000000000000000000000000000", "hex"), 0),
         "keyId": Long("0")
      }
   },
   "operationTime": Timestamp({ "t": 1666275705, "i": 1 })
}
```

## Use Cases

Change streams can benefit architectures with reliant business systems,
informing downstream systems once data changes are durable. For example,
change streams can save time for developers when implementing Extract,
Transform, and Load (ETL) services, cross-platform synchronization,
collaboration functionality, and notification services.

<span id="std-label-change-streams-access" />

## Access Control

For deployments enforcing Authentication on Self-Managed Deployments and authorization:

* To open a change stream against specific collection, applications
  must have privileges that grant `changeStream` and
  `find` actions on the corresponding collection.

  ```javascript
  { resource: { db: <dbname>, collection: <collection> }, actions: [ "find", "changeStream" ] }
  ```

* To open a change stream on a single database, applications must have
  privileges that grant `changeStream` and
  `find` actions on all non-`system` collections in the
  database.

  ```javascript
  { resource: { db: <dbname>, collection: "" }, actions: [ "find", "changeStream" ] }
  ```

* To open a change stream on an entire deployment, applications must
  have privileges that grant `changeStream` and
  `find` actions on all non-`system` collections for all
  databases in the deployment.

  ```javascript
  { resource: { db: "", collection: "" }, actions: [ "find", "changeStream" ] }
  ```

<span id="std-label-change-streams-event-notification" />

## Event Notification

Change streams only notify on data changes that have persisted to a majority
of data-bearing members in the replica set. This ensures that notifications are
triggered only by majority-committed changes that are durable in failure
scenarios.

For example, consider a 3-member replica set with a change stream
cursor opened against the primary. If a client issues an insert
operation, the change stream only notifies the application of the data change
once that insert has persisted to a majority of data-bearing members.

If an operation is associated with a transaction, the change event document includes the
`txnNumber` and the `lsid`.

## Collation

Change streams use `simple` binary comparisons unless an explicit collation is
provided.

## Change Streams and Orphan Documents

<Include href="/includes/change-streams-and-orphans.rst">
  Starting in MongoDB 5.3, during range migration, change stream
  events are not generated for updates to orphaned documents.
</Include>

<span id="std-label-change-stream-pre-post-images" />

## Change Streams with Document Pre- and Post-Images

<Include href="/includes/change-stream-pre-and-post-images-introduction.rst">
  Starting in MongoDB 6.0, you can use change stream events to output the version of a document before and
  after changes (the document pre- and post-images):

  * The pre-image is the document before it was replaced, updated, or
    deleted. There is no pre-image for an inserted document.

  * The post-image is the document after it was inserted, replaced, or
    updated. There is no post-image for a deleted document.

  * Enable `changeStreamPreAndPostImages` for a collection using
    `db.createCollection()`, `create`, or
    `collMod`.
</Include>

<Include href="/includes/change-stream-pre-and-post-images-additional-information.rst">
  Pre- and post-images are not available for a change stream event if the images were:

  * Not enabled on the collection at the time of a document update or
    delete operation.

  * Removed after the pre- and post-image retention time set in
    `expireAfterSeconds`.

    * The following example sets `expireAfterSeconds` to `100`
      seconds on an entire cluster:

      ```javascript
      use admin
      db.runCommand( {
         setClusterParameter:
            { changeStreamOptions: {
               preAndPostImages: { expireAfterSeconds: 100 }
            } }
      } )
      ```

    * The following example returns the current `changeStreamOptions`
      settings, including `expireAfterSeconds`:

      ```javascript
      db.adminCommand( { getClusterParameter: "changeStreamOptions" } )
      ```

    * Setting `expireAfterSeconds` to `off` uses the default retention
      policy: pre- and post-images are retained until the corresponding
      change stream events are removed from the oplog.

    * If a change stream event is removed from the oplog, then the
      corresponding pre- and post-images are also deleted regardless of
      the `expireAfterSeconds` pre- and post-image retention time.

  Additional considerations:

  * Enabling pre- and post-images consumes storage space and adds
    processing time. Only enable pre- and post-images if you need them.

  * Limit the change stream event size to less than 16 mebibytes. To limit
    the event size, you can:

    * Limit the document size to 8 megabytes. You can request pre- and
      post-images simultaneously in the change stream output if other change stream event fields like
      `updateDescription` are not large.

    * Request only post-images in the change stream output for documents
      up to 16 mebibytes if other change stream event fields like
      `updateDescription` are not large.

    * Request only pre-images in the change stream output for documents up
      to 16 mebibytes if:

      * document updates affect only a small fraction of the document
        structure or content, *and*

      * do not cause a `replace` change event. A `replace` event
        always includes the post-image.

  * To request a pre-image, you set `fullDocumentBeforeChange` to
    `required` or `whenAvailable` in `db.collection.watch()`.
    To request a post-image, you set `fullDocument` using the same
    method.

  * Pre-images are written to the `config.system.preimages`
    collection.

    * The `config.system.preimages` collection may become large. To
      limit the collection size, you can set `expireAfterSeconds`
      time for the pre-images as shown earlier.

    * Pre-images are removed asynchronously by a background process.

  <Important>
    Backward-Incompatible Feature

    <Include href="/includes/downgrade-for-pre-and-post-images.rst">
      Starting in MongoDB 6.0, if you are using document pre- and post-images
      for change streams, you must disable
      changeStreamPreAndPostImages for each collection using
      the `collMod` command before you can downgrade to an earlier
      MongoDB version.
    </Include>
  </Important>

  <Seealso>
    * For change stream events and output, see
      Change Events.

    * To watch a collection for changes, see
      `db.collection.watch()`.

    * For complete examples with the change stream output, see
      Change Streams with Document Pre- and Post-Images.
  </Seealso>
</Include>

For complete examples with the change stream output, see
Change Streams with Document Pre- and Post-Images.

<Toctree titlesonly={true} hidden={true} />
